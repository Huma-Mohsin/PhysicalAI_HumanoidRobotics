openapi: 3.0.3
info:
  title: Physical AI RAG Platform API
  description: Backend API for the Physical AI & Humanoid Robotics Capstone Book & RAG Platform
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: https://api.physical-ai-platform.example.com
    description: Production server
  - url: http://localhost:8000
    description: Local development server

tags:
  - name: Chat
    description: RAG chatbot endpoints
  - name: Auth
    description: Authentication endpoints (Better-Auth integration)
  - name: Feedback
    description: User feedback endpoints
  - name: Admin
    description: Administrative endpoints (content indexing, monitoring)

paths:
  /chat:
    post:
      tags: [Chat]
      summary: Submit a query to the RAG chatbot
      description: |
        Processes a user query using RAG (Retrieval-Augmented Generation).
        Supports both general queries and contextual queries (based on selected text).
        Returns a generated response with optional source citations.
      operationId: chat
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              generalQuery:
                summary: General query
                value:
                  query: "What is a ROS 2 node?"
                  language: "en"
                  session_id: "sess_12345"
              contextualQuery:
                summary: Contextual query with selected text
                value:
                  query: "What sensors are mentioned here?"
                  selected_text: "Gazebo supports various sensor types including Lidar, cameras, and IMUs for robot simulation."
                  language: "en"
                  session_id: "sess_12345"
      responses:
        '200':
          description: Successful response with generated answer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
        '400':
          description: Bad request (e.g., invalid language, selected_text too short)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized (invalid session token)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - bearerAuth: []  # Optional: allows anonymous queries

  /auth/signup:
    post:
      tags: [Auth]
      summary: Register a new user account
      description: |
        Creates a new user account with email/password authentication.
        Captures hardware profile information during signup for content personalization.
      operationId: signup
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SignupRequest'
      responses:
        '201':
          description: User account created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Bad request (e.g., email already exists, weak password)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/signin:
    post:
      tags: [Auth]
      summary: Sign in to an existing account
      description: |
        Authenticates a user with email/password credentials.
        Returns a JWT token with 7-day expiration for session management.
      operationId: signin
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SigninRequest'
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/profile:
    get:
      tags: [Auth]
      summary: Get current user's profile and hardware settings
      description: Returns user profile including hardware preferences (OS, GPU, environment mode, language)
      operationId: getProfile
      responses:
        '200':
          description: Profile retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - bearerAuth: []

    patch:
      tags: [Auth]
      summary: Update user's hardware profile
      description: Updates environment preference, language preference, or hardware details
      operationId: updateProfile
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProfileUpdateRequest'
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '400':
          description: Bad request (invalid enum values)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - bearerAuth: []

  /feedback:
    post:
      tags: [Feedback]
      summary: Submit feedback for a chatbot response
      description: |
        Records user feedback (thumbs up/down) for a specific chat message.
        Optionally includes text feedback for elaboration.
      operationId: submitFeedback
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FeedbackRequest'
      responses:
        '201':
          description: Feedback submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FeedbackResponse'
        '400':
          description: Bad request (e.g., message_id not found, duplicate feedback)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - bearerAuth: []  # Optional: allows anonymous feedback

  /admin/index_content:
    post:
      tags: [Admin]
      summary: Trigger content indexing for RAG
      description: |
        Administrative endpoint to parse Markdown content files,
        generate embeddings, and populate Qdrant vector database.
        Requires admin authentication.
      operationId: indexContent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IndexRequest'
      responses:
        '200':
          description: Indexing completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/IndexResponse'
        '401':
          description: Unauthorized (admin role required)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error during indexing
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - bearerAuth: []

  /health:
    get:
      tags: [Admin]
      summary: Health check endpoint
      description: Returns API status and database connectivity
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  database:
                    type: string
                    example: "connected"
                  vector_db:
                    type: string
                    example: "connected"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Better-Auth JWT token (7-day expiration)

  schemas:
    ChatRequest:
      type: object
      required:
        - query
        - language
        - session_id
      properties:
        query:
          type: string
          description: User's question or prompt
          minLength: 1
          maxLength: 5000
          example: "What is a ROS 2 node?"
        selected_text:
          type: string
          description: User-selected text for contextual queries (optional, minimum 50 characters)
          minLength: 50
          maxLength: 10000
          example: "ROS 2 nodes are the fundamental building blocks..."
        language:
          type: string
          enum: [en, ur]
          description: Language for the response (matches current content mode)
          example: "en"
        session_id:
          type: string
          description: Session identifier for conversation context
          example: "sess_abc123"

    ChatResponse:
      type: object
      required:
        - message_id
        - response
        - citations
      properties:
        message_id:
          type: string
          format: uuid
          description: Unique identifier for this message (for feedback submission)
          example: "550e8400-e29b-41d4-a716-446655440000"
        response:
          type: string
          description: Generated answer from the RAG system
          example: "A ROS 2 node is a process that performs computation. Nodes communicate with each other using topics, services, and actions."
        citations:
          type: array
          description: Source citations for the response
          items:
            $ref: '#/components/schemas/Citation'
        is_contextual:
          type: boolean
          description: Whether this was a contextual query (based on selected text)
          example: false

    Citation:
      type: object
      required:
        - module
        - chapter
        - page_url
      properties:
        module:
          type: string
          example: "module-1-ros2"
        chapter:
          type: string
          example: "nodes"
        section_heading:
          type: string
          example: "Creating a Node"
        page_url:
          type: string
          format: uri
          example: "/docs/module-1-ros2/nodes#creating-a-node"
        relevance_score:
          type: number
          format: float
          description: Similarity score (0.0-1.0)
          example: 0.92

    SignupRequest:
      type: object
      required:
        - email
        - password
        - os_type
      properties:
        email:
          type: string
          format: email
          example: "learner@example.com"
        password:
          type: string
          format: password
          minLength: 8
          description: Minimum 8 characters (Better-Auth enforces complexity)
          example: "SecurePass123!"
        os_type:
          type: string
          description: Operating system (free text, user self-reported)
          example: "Ubuntu 22.04"
        gpu_model:
          type: string
          description: GPU model (optional, user self-reported)
          example: "RTX 4070 Ti"

    SigninRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          example: "learner@example.com"
        password:
          type: string
          format: password
          example: "SecurePass123!"

    AuthResponse:
      type: object
      required:
        - token
        - user
      properties:
        token:
          type: string
          description: JWT token for authenticated requests (7-day expiration)
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
        user:
          $ref: '#/components/schemas/UserProfile'

    UserProfile:
      type: object
      required:
        - id
        - email
        - hardware_profile
      properties:
        id:
          type: string
          format: uuid
          example: "550e8400-e29b-41d4-a716-446655440000"
        email:
          type: string
          format: email
          example: "learner@example.com"
        hardware_profile:
          $ref: '#/components/schemas/HardwareProfile'

    HardwareProfile:
      type: object
      required:
        - os_type
        - environment_preference
        - language_preference
      properties:
        os_type:
          type: string
          example: "Ubuntu 22.04"
        gpu_model:
          type: string
          nullable: true
          example: "RTX 4070 Ti"
        environment_preference:
          type: string
          enum: [workstation, cloud, mac]
          example: "workstation"
        language_preference:
          type: string
          enum: [en, ur]
          example: "en"

    ProfileUpdateRequest:
      type: object
      properties:
        os_type:
          type: string
          example: "Ubuntu 22.04"
        gpu_model:
          type: string
          nullable: true
          example: "RTX 4090"
        environment_preference:
          type: string
          enum: [workstation, cloud, mac]
          example: "cloud"
        language_preference:
          type: string
          enum: [en, ur]
          example: "ur"

    FeedbackRequest:
      type: object
      required:
        - message_id
        - rating
      properties:
        message_id:
          type: string
          format: uuid
          description: ID of the chat message being rated
          example: "550e8400-e29b-41d4-a716-446655440000"
        rating:
          type: string
          enum: [thumbs_up, thumbs_down]
          example: "thumbs_up"
        optional_text:
          type: string
          description: Optional elaboration (encouraged for thumbs_down)
          maxLength: 1000
          example: "The answer was helpful but could include more code examples."

    FeedbackResponse:
      type: object
      required:
        - feedback_id
        - message:
          type: string
          format: uuid
          example: "660e9500-f39c-52e5-b827-557766551111"
        message:
          type: string
          example: "Feedback submitted successfully"

    IndexRequest:
      type: object
      required:
        - language
      properties:
        language:
          type: string
          enum: [en, ur, both]
          description: Which language content to index
          example: "both"
        force_reindex:
          type: boolean
          description: Whether to clear existing embeddings and reindex from scratch
          default: false
          example: false

    IndexResponse:
      type: object
      required:
        - status
        - chunks_indexed
        - language
      properties:
        status:
          type: string
          enum: [success, partial, failed]
          example: "success"
        chunks_indexed:
          type: object
          properties:
            en:
              type: integer
              example: 1243
            ur:
              type: integer
              example: 1189
        language:
          type: string
          example: "both"
        duration_seconds:
          type: number
          format: float
          example: 127.45

    Error:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code or type
          example: "INVALID_REQUEST"
        message:
          type: string
          description: Human-readable error message
          example: "The 'selected_text' field must be at least 50 characters long."
        details:
          type: object
          description: Additional error context (optional)
          example: { "field": "selected_text", "min_length": 50 }
